# Story 1.3: Go Hook System Implementation

## Status
Draft

## Story
**As a** developer,
**I want** an integrated Go-based hook system,
**so that** Claude Code events are processed with type safety and performance.

## Acceptance Criteria
1. `spcstr hook <hook-name>` command processes all Claude hook events
2. Hook execution completes within 10ms including file I/O
3. Session state uses proper data model with categorized file operations
4. Atomic writes prevent data corruption during concurrent operations
5. Claude settings.json updated to use Go hook commands
6. Existing shell hooks from Story 1.2 are completely removed (no migration)
7. Tool usage tracking with accurate counts per tool type
8. Agent history maintained with timestamps for all executions

## Tasks / Subtasks
- [ ] Implement main hook command dispatcher (AC: 1, 5)
  - [ ] Create cmd/spcstr/hook.go as hook subcommand entry point
  - [ ] Parse hook name argument and stdin for Claude events
  - [ ] Route to appropriate handler based on hook type
  - [ ] Implement proper error handling with non-blocking behavior
- [ ] Create hook data structures and types (AC: 3, 7, 8)
  - [ ] Create internal/hooks/types.go with SessionState, AgentHistoryEntry, FileOperations models
  - [ ] Implement tool usage tracking map[string]int structure
  - [ ] Create ErrorEntry struct for structured error logging
  - [ ] Add JSON tags for proper serialization
- [ ] Implement session state management (AC: 3, 4)
  - [ ] Create internal/hooks/state.go with LoadSessionState/SaveSessionState functions
  - [ ] Implement atomic file operations using temp file + rename pattern
  - [ ] Add file locking mechanism to prevent concurrent access corruption
  - [ ] Handle session creation when state file doesn't exist
- [ ] Create individual hook handlers (AC: 1, 7, 8)
  - [ ] Create internal/hooks/handlers/ directory structure
  - [ ] Implement internal/hooks/handlers/pre_tool_use.go for safety checks
  - [ ] Implement internal/hooks/handlers/post_tool_use.go for tool tracking & file ops
  - [ ] Implement internal/hooks/handlers/session_start.go for session initialization
  - [ ] Implement internal/hooks/handlers/session_end.go for session finalization
  - [ ] Implement internal/hooks/handlers/user_prompt.go for prompt filtering
  - [ ] Implement internal/hooks/handlers/notification.go for notification logging
  - [ ] Implement internal/hooks/handlers/stop.go for stop handling
  - [ ] Implement internal/hooks/handlers/subagent_stop.go for agent tracking
  - [ ] Implement internal/hooks/handlers/pre_compact.go for compaction prep
- [ ] Implement atomic persistence operations (AC: 4)
  - [ ] Create internal/hooks/persistence.go with atomic file I/O functions
  - [ ] Implement temp file + rename pattern for all write operations
  - [ ] Add retry logic with exponential backoff for file lock contention
  - [ ] Ensure POSIX atomic write compatibility across platforms
- [ ] Update Claude settings integration (AC: 5)
  - [ ] Modify internal/hooks/claude.go to use Go hook commands instead of shell scripts
  - [ ] Update hook command format to use `spcstr hook <hook-name>`
  - [ ] Preserve existing Claude settings backup functionality
  - [ ] Test settings update with various Claude Code installation paths
- [ ] Remove shell hook system (AC: 6)
  - [ ] Delete all files in .spcstr/hooks directory
  - [ ] Remove shell script dependencies completely
  - [ ] Update Claude settings.json with Go hook commands (PROJECT folder only)
  - [ ] Document removal in completion notes
- [ ] Add comprehensive error handling (AC: 1)
  - [ ] Implement structured error logging with ErrorEntry struct
  - [ ] Ensure hook operations never block Claude Code (always return 0)
  - [ ] Add debug logging to .spcstr/logs/debug.log
  - [ ] Create error recovery mechanisms for corrupted session state
- [ ] Implement performance optimizations (AC: 2)
  - [ ] Profile hook execution to ensure <10ms completion
  - [ ] Optimize JSON serialization/deserialization performance
  - [ ] Implement in-memory caching for frequently accessed session state
  - [ ] Add performance benchmarks in test suite
- [ ] Create comprehensive test suite (AC: All)
  - [ ] Unit tests for all hook handlers with table-driven tests
  - [ ] Integration tests for end-to-end hook processing
  - [ ] Performance benchmarks for critical path operations
  - [ ] Mock file system operations for deterministic testing

## Dev Notes

### Critical Requirements Updates
- **NO BACKWARDS COMPATIBILITY**: Remove all existing shell hooks completely, do not preserve or migrate them
- **PROJECT-ONLY SETTINGS**: Only update Claude settings.json in the PROJECT folder (never in user's home directory)
- **CLEAN CUTOVER**: Direct replacement with Go hooks, no transition period
- **Claude Settings Location**: The `UpdateClaudeSettings()` function in internal/hooks/claude.go must ONLY update PROJECT folder settings

### Previous Story Insights
From Story 1.2 completion:
- Shell hook scripts successfully implemented with POSIX compliance
- Atomic write patterns established using temp + rename
- Claude settings.json update logic proven reliable
- Hook script error handling pattern established (set +e, exit 0)
- XDG directory support implemented for cross-platform compatibility

### Data Models
From [Source: architecture/data-models.md#sessionstate-model]:
- **SessionState**: Main session tracking structure with session_id (format: sess_{uuid}), timestamps, source enum, project_path, status enum, agents array, agents_history, files (FileOperations), tools_used map, errors array, modified flag
- **AgentHistoryEntry**: Agent execution tracking with name, started_at, ended_at timestamps
- **FileOperations**: Categorized file operations with new/edited/read string arrays for absolute paths
- **ErrorEntry**: Structured error logging with timestamp, hook name, message
- **Tool Usage**: map[string]int tracking tool invocations (Read, Write, Edit, MultiEdit, Bash, Task, etc.)

### API Specifications
From [Source: architecture/database-schema.md#session-state-schema]:
- JSON schema with strict validation requirements
- session_id pattern: ^sess_[a-zA-Z0-9-]+$
- ISO 8601 timestamps for all time fields
- Enum validation for source (startup/resume/clear) and status (active/completed/error)
- File paths must be absolute strings
- Tools_used object with integer counts (minimum 0)

### Component Specifications
From [Source: architecture/components.md#hook-manager-component]:
- **HandleHook(hookName, stdin)**: Main hook processing entry point
- **LoadSessionState()**: Atomic session state loading
- **SaveSessionState()**: Atomic session state persistence
- **ValidateToolUsage()**: Safety checks for dangerous operations
- **UpdateClaudeSettings()**: Claude configuration updates
- Technology: Native Go 1.21.0, encoding/json, atomic file operations

### File Locations
From [Source: architecture/source-tree.md]:
- Hook command entry: cmd/spcstr/hook.go
- Hook data structures: internal/hooks/types.go
- Session state management: internal/hooks/state.go
- Hook handlers: internal/hooks/handlers/*.go
- Atomic persistence: internal/hooks/persistence.go
- Claude integration: internal/hooks/claude.go (existing, to be modified)
- Public hook models: pkg/hooks/*.go
- Test files: Same directory as source with _test.go suffix

### Testing Requirements
From [Source: architecture/test-strategy-and-standards.md]:
- Test framework: Go standard library testing package
- Mock framework: testify/mock 1.8.4
- Coverage target: 80% minimum for new packages
- Test pattern: Table-driven tests required
- File location: Same directory as source with _test.go suffix
- Integration tests: test/integration/
- Performance benchmarks: *_bench_test.go suffix
- All public functions must have tests with error paths explicitly tested

### Technical Constraints
From [Source: architecture/tech-stack.md]:
- Go version: 1.21.0 (strict requirement)
- JSON handling: encoding/json standard library only
- No external dependencies for core hook functionality
- Hook execution: <10ms performance requirement
- File operations: Must use atomic write patterns
- Cross-platform compatibility: POSIX compliance required

### Error Handling Strategy
From [Source: architecture/error-handling-strategy.md#hook-script-error-handling]:
- **CRITICAL**: Hook operations must NEVER block Claude Code
- All errors logged to .spcstr/logs/debug.log
- Structured error tracking with ErrorEntry model
- Retry logic with exponential backoff for file contention
- Error wrapping with context using fmt.Errorf with %w
- Recovery mechanisms for corrupted session state

### Performance Requirements
From [Source: architecture/database-schema.md#performance-considerations]:
- Hook execution: <10ms total including file I/O
- JSON read/write: <10ms target for session state operations
- Concurrent access: File-based locking with max 100ms wait
- Atomic writes: temp file + rename for POSIX atomicity
- Caching: In-memory state cache with fsnotify invalidation

### Security Considerations
From [Source: architecture/error-handling-strategy.md]:
- Session ID correlation for all logged operations
- No sensitive data in logs (only session IDs)
- Atomic file operations prevent partial state corruption
- File permissions: Maintain existing 0755/0644 patterns from Story 1.2
- Input validation for all hook event data

## Testing

### Testing Standards
From [Source: architecture/test-strategy-and-standards.md]:
- **Test Framework**: Go standard library testing package
- **File Location**: Same directory as source with _test.go suffix
- **Mock Library**: testify/mock 1.8.4 for external dependencies
- **Coverage Target**: 80% minimum for business logic packages
- **Test Pattern**: Table-driven tests required for all functions
- **Organization**: One test file per source file with matching name
- **Integration Tests**: Located in test/integration/ directory
- **Benchmarks**: Performance tests with _bench_test.go suffix

### Test Files Required
- internal/hooks/types_test.go - Test data structure serialization/deserialization
- internal/hooks/state_test.go - Test session state loading/saving with atomic operations
- internal/hooks/persistence_test.go - Test atomic file I/O operations
- internal/hooks/handlers/*_test.go - Test individual hook handler logic
- cmd/spcstr/hook_test.go - Test main hook command dispatcher
- test/integration/hook_system_test.go - End-to-end hook processing tests
- internal/hooks/performance_bench_test.go - Performance benchmarks

### Specific Testing Requirements
- Mock file system operations for deterministic tests
- Test atomic write failure recovery scenarios
- Verify hook execution completes within 10ms performance requirement
- Test concurrent session access with file locking
- Validate JSON schema compliance for all data structures
- Test Claude settings.json update edge cases
- Verify clean shell hook removal

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-05 | 1.0 | Initial story draft created | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by development agent*

### Debug Log References
*To be filled by development agent*

### Completion Notes List
*To be filled by development agent*

### File List
*To be filled by development agent*

## QA Results
*This section will be populated by QA Agent after story completion*
