# Sprint Change Proposal: TUI Architecture Simplification

## Change Context

### Triggering Story
Story 1.5: TUI Foundation and Navigation (marked complete but non-functional)

### Core Problem
The TUI implementation is overly complicated, leading to:
1. Blank screen on launch (components returning empty strings)
2. Content wider than terminal (improper width handling)
3. Complex component initialization that doesn't follow Bubbletea patterns

### Evidence
- QA testing revealed blank screen despite keyboard shortcuts working
- Content extends beyond terminal width causing layout breaks
- Analysis of Lipgloss/Bubbletea examples shows our implementation deviates significantly from established patterns

## Impact Analysis

### Current Epic Impact
**Epic 1: Core Infrastructure** - Story 1.5 is blocking progress:
- Cannot proceed to Story 1.6 (Plan View implementation) with broken foundation
- Story 1.7 (Observe View) also blocked
- Story 1.8 (Full TUI Integration) impossible without working base

### Future Epic Impact
**Epic 2: Enhanced Features** - All stories depend on working TUI:
- Story 2.1 (Real-time Updates) requires stable view system
- Story 2.2 (Search) needs reliable component rendering
- Story 2.3 (Export) requires functional navigation

**Epic 3: AI Integration** - Cannot integrate AI features into broken TUI

### Artifact Conflicts

#### Architecture Document Violations
- **Component Template Pattern** (architecture/frontend-architecture.md): Current implementation adds unnecessary complexity beyond the template
- **Single Binary Rule**: No violation, but complexity threatens maintainability

#### No PRD Conflicts
The refactor aligns with PRD goals of simplicity and maintainability

## Root Cause Analysis

### Pattern Deviations from Examples

#### 1. Component Over-Engineering
**Current (Wrong):**
```go
type App struct {
    state *AppState
}
type AppState struct {
    planView    tea.Model  // Separate model instance
    observeView tea.Model  // Separate model instance
    header      tea.Model  // Separate model instance
    footer      tea.Model  // Separate model instance
}
```

**Examples Pattern (Correct):**
```go
type model struct {
    currentView ViewType
    width       int
    height      int
    // Simple fields, not separate models
}
```

#### 2. Width Management Issues
**Current (Wrong):**
```go
style.Width(m.width - 4)  // Fixed width, doesn't account for terminal
```

**Examples Pattern (Correct):**
```go
docStyle.MaxWidth(physicalWidth)  // Responsive width
lipgloss.JoinHorizontal(lipgloss.Top, components...)  // Let lipgloss handle layout
```

#### 3. View Rendering Complexity
**Current (Wrong):**
- Each component has Init(), Update(), View() methods
- Complex state propagation between components
- Empty string returns when not initialized

**Examples Pattern (Correct):**
- Single model with single Update() method
- View() uses simple conditional rendering
- Always returns displayable content

## Recommended Path Forward

### Option Selected: Direct Adjustment with Architectural Simplification

Refactor the TUI to follow the patterns from Bubbletea/Lipgloss examples:

1. **Flatten the component architecture** - Single model struct, not nested models
2. **Use functional rendering** - Components as functions, not structs with methods
3. **Implement proper width handling** - MaxWidth(), JoinHorizontal/Vertical
4. **Simplify state management** - All state in one place
5. **Follow initialization patterns** - Handle nil/zero states gracefully

## Proposed Changes

### 1. Restructure `internal/tui/app/app.go`

**Replace current complex App/AppState with:**
```go
type model struct {
    // Core state
    currentView  ViewType
    width        int
    height       int
    initialized  bool
    projectPath  string

    // View-specific state (simple fields, not models)
    planContent   string
    observeContent string
    sessionActive bool

    // Performance tracking
    lastSwitch time.Time
}

func (m model) Init() tea.Cmd {
    return nil  // Simple, no complex initialization
}

func (m model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    switch msg := msg.(type) {
    case tea.WindowSizeMsg:
        m.width = msg.Width
        m.height = msg.Height
    case tea.KeyMsg:
        switch msg.String() {
        case "p":
            m.currentView = ViewPlan
            m.lastSwitch = time.Now()
        case "o":
            m.currentView = ViewObserve
            m.lastSwitch = time.Now()
        case "q", "ctrl+c":
            return m, tea.Quit
        }
    }
    return m, nil
}

func (m model) View() string {
    if m.width == 0 {
        return "Loading..."  // Always return something
    }

    // Build layout using lipgloss composition
    header := m.renderHeader()
    content := m.renderContent()
    footer := m.renderFooter()

    return lipgloss.JoinVertical(
        lipgloss.Left,
        header,
        content,
        footer,
    )
}
```

### 2. Convert Components to Rendering Functions

**Transform `internal/tui/components/header/header.go` to:**
```go
package components

func RenderHeader(viewName string, sessionActive bool, width int) string {
    if width == 0 {
        width = 80  // Fallback width
    }

    left := fmt.Sprintf(" %s ", viewName)
    right := "● Active"
    if !sessionActive {
        right = "○ Inactive"
    }

    gap := width - lipgloss.Width(left) - lipgloss.Width(right)
    middle := strings.Repeat(" ", max(0, gap))

    return lipgloss.JoinHorizontal(
        lipgloss.Top,
        headerStyle.Render(left),
        middle,
        statusStyle.Render(right),
    )
}
```

### 3. Simplify View Implementations

**Transform `internal/tui/views/plan/plan.go` to:**
```go
package views

func RenderPlanView(width, height int) string {
    content := `Plan View

Documents:
• PRD.md
• Architecture.md
• Epic-1.md

Press 'o' for Observe view`

    return lipgloss.NewStyle().
        MaxWidth(width).
        Height(height).
        Padding(1, 2).
        Render(content)
}
```

### 4. Update Main Command

**Simplify `cmd/spcstr/main.go` TUI launch:**
```go
if len(args) == 0 {
    m := tui.NewModel()  // Simple constructor
    p := tea.NewProgram(m, tea.WithAltScreen())
    if _, err := p.Run(); err != nil {
        return fmt.Errorf("error running TUI: %w", err)
    }
    return nil
}
```

### 5. File Structure Changes

**Remove overcomplicated files:**
- Delete separate model files in components/
- Consolidate styles into single theme.go
- Merge component logic into rendering functions

**New structure:**
```
internal/tui/
├── model.go           # Single model definition
├── update.go          # Update logic
├── view.go            # View rendering
├── components.go      # Component rendering functions
└── styles/
    └── theme.go       # All styles in one place
```

## Implementation Plan

### Phase 1: Core Refactor (Priority 1)
1. Create new simplified model structure
2. Implement basic Update() with navigation
3. Create View() with proper layout composition
4. Test basic TUI launch and navigation

### Phase 2: Component Migration (Priority 2)
1. Convert header to rendering function
2. Convert footer to rendering function
3. Create placeholder view renderers
4. Verify terminal resize handling

### Phase 3: Testing & Polish (Priority 3)
1. Add performance measurements
2. Update tests for new structure
3. Document new patterns
4. Manual testing across terminal sizes

## Success Criteria

1. **TUI launches with visible content** - No blank screens
2. **Content fits terminal width** - Proper responsive layout
3. **Navigation works instantly** - <100ms view switching
4. **Code follows examples** - Matches Bubbletea/Lipgloss patterns
5. **Reduced complexity** - Fewer files, simpler logic

## Risk Mitigation

- **Backup current implementation** before refactor
- **Incremental refactor** - Test each phase
- **Reference examples** throughout implementation
- **Keep original acceptance criteria** - Don't change requirements

## Next Steps

1. **Developer Agent** to implement the refactor following this proposal
2. **QA validation** after each phase
3. **Update Story 1.5** status after successful refactor
4. **Proceed to Story 1.6** once foundation is stable

## Approval

This change proposal recommends a **Direct Adjustment** approach through architectural simplification. The refactor will:
- Maintain all original functionality
- Follow established Bubbletea/Lipgloss patterns
- Reduce code complexity significantly
- Enable future story implementation

**Estimated Impact:** 2-3 hours of refactoring to save days of future debugging

---

*Generated by Bob (Scrum Master) - Sprint Change Proposal for Story 1.5*
*Date: 2025-09-06*
