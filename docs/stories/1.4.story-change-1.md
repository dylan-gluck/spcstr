# Story 1.4 Change Request #1: Hook Settings JSON Format Correction

## Change Summary
The hook settings JSON format generated by the `spcstr init` command is incorrect and incompatible with Claude Code's expected format. This prevents all hooks from functioning.

## Issue Identification
- **Discovered**: Post-implementation review of Story 1.4
- **Severity**: HIGH - Complete hook system failure
- **Root Cause**: Misinterpretation of Claude Code hooks configuration structure

## Current vs Required Format

### Current (Incorrect) Format
```json
{
  "hooks": {
    "session_start": "spcstr hook session_start --cwd=\"${CLAUDE_PROJECT_DIR}\"",
    "user_prompt_submit": "spcstr hook user_prompt_submit --cwd=\"${CLAUDE_PROJECT_DIR}\"",
    ...
  }
}
```

### Required (Correct) Format
```json
{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "spcstr hook session_start --cwd=\"${CLAUDE_PROJECT_DIR}\""
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "spcstr hook user_prompt_submit --cwd=\"${CLAUDE_PROJECT_DIR}\""
          }
        ]
      }
    ],
    ...
  }
}
```

## Impact Analysis

### Affected Components
1. **internal/config/init.go**: `configureClaudeHooks` function (lines 125-139)
2. **internal/config/init_test.go**: Missing JSON structure validation
3. **.claude/settings.json**: Generated with incorrect format

### Dependencies
- No impact on hook handlers (already correctly implemented in Story 1.3)
- No impact on CLI command structure
- No impact on TUI components

## Implementation Plan

### Task 1: Update Hook Configuration Logic
**File**: `internal/config/init.go`
**Function**: `configureClaudeHooks`

Replace the flat map structure with properly nested structure following Claude Code specification:
- Event names use PascalCase (SessionStart, not session_start)
- Each event contains an array of matcher configurations
- Each configuration has optional `matcher` field and required `hooks` array
- Each hook has `type: "command"` and `command` fields

### Task 2: Add JSON Structure Validation Tests
**File**: `internal/config/init_test.go`
**Function**: `TestConfigureClaudeHooks`

Add test cases to verify:
- Correct nested structure is generated
- Event names are in PascalCase
- Hooks array contains proper command objects
- Matcher field is present where required

### Task 3: Manual Testing Checklist
1. Run `spcstr init` in a test directory
2. Verify `.claude/settings.json` has correct structure
3. Open Claude Code in the initialized directory
4. Run `/hooks` command to verify hooks are recognized
5. Test a simple prompt to verify `UserPromptSubmit` hook triggers
6. Start a new session to verify `SessionStart` hook triggers

### Task 4: Migration Strategy (Optional)
For users who already ran `spcstr init` with the incorrect format:
1. Create a migration script to update existing settings.json files
2. OR document manual correction steps
3. OR have `spcstr init --force` automatically fix the format

## Code Changes

### internal/config/init.go
```go
// configureClaudeHooks creates or updates .claude/settings.json with hook configurations
func configureClaudeHooks(ctx context.Context, projectDir string) error {
    // ... existing code up to line 124 ...

    // Define hooks in correct Claude Code format
    hooks := map[string]interface{}{
        "SessionStart": []map[string]interface{}{
            {
                "matcher": "",
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook session_start --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
        "UserPromptSubmit": []map[string]interface{}{
            {
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook user_prompt_submit --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
        "PreToolUse": []map[string]interface{}{
            {
                "matcher": "*",
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook pre_tool_use --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
        "PostToolUse": []map[string]interface{}{
            {
                "matcher": "*",
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook post_tool_use --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
        "Notification": []map[string]interface{}{
            {
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook notification --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
        "PreCompact": []map[string]interface{}{
            {
                "matcher": "*",
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook pre_compact --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
        "SessionEnd": []map[string]interface{}{
            {
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook session_end --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
        "Stop": []map[string]interface{}{
            {
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook stop --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
        "SubagentStop": []map[string]interface{}{
            {
                "hooks": []map[string]interface{}{
                    {
                        "type":    "command",
                        "command": `spcstr hook subagent_stop --cwd="${CLAUDE_PROJECT_DIR}"`,
                    },
                },
            },
        },
    }

    // Set hooks in settings
    settings["hooks"] = hooks

    // ... rest of function ...
}
```

## Testing Requirements

### Unit Tests
- Verify JSON structure matches Claude Code specification
- Test that existing settings are preserved during update
- Validate event name casing (PascalCase)
- Check proper nesting of matcher and hooks arrays

### Integration Tests
- Full init command generates correct settings.json
- Force flag properly overwrites with correct format
- Settings file is valid JSON and parseable by Claude Code

## Rollback Plan
If issues arise after deployment:
1. Revert internal/config/init.go to previous version
2. Document manual correction steps for affected users
3. Re-assess Claude Code documentation interpretation

## Success Criteria
1. ✅ `spcstr init` generates settings.json with correct hook format
2. ✅ Claude Code recognizes and executes hooks
3. ✅ All unit and integration tests pass
4. ✅ Manual testing confirms hook functionality

## Timeline
- Implementation: 1-2 hours
- Testing: 30 minutes
- Documentation update: 15 minutes
- Total: ~2.5 hours

## Risk Assessment
- **Risk Level**: LOW
- **Rationale**: Isolated change to single function, clear specification to follow
- **Mitigation**: Comprehensive testing before release

## Approval Status
- [x] Change approved by Scrum Master
- [x] Implementation started
- [x] Testing completed
- [x] Ready for merge

## Dev Agent Record

### Agent Model Used
- Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- `go test ./internal/config/ -v` - All tests passed
- `go test ./... -v` - Full test suite passed
- `make build` - Successfully built binary
- `/tmp/test-spcstr-init/.claude/settings.json` - Verified correct JSON format

### Completion Notes
- Updated `configureClaudeHooks` function in `internal/config/init.go` to generate correct Claude Code hook format
- Changed from flat map structure to nested array structure with PascalCase event names
- Added proper `matcher` fields where required (PreToolUse, PostToolUse, PreCompact)
- Updated test validation in `internal/config/init_test.go` to verify correct JSON structure
- All hooks now use `type: "command"` and proper nesting as per Claude Code specification
- Manual testing confirms generated settings.json is correctly formatted

### File List
- Modified: `internal/config/init.go`
- Modified: `internal/config/init_test.go`

## Change Log
- **2025-09-06**: Implemented hook settings JSON format correction per Claude Code specification - James (Developer)

## Status
Ready for Review

---
*Generated by: Bob (Scrum Master)*
*Date: 2025-09-06*
*Story: 1.4 - CLI and Init Command*