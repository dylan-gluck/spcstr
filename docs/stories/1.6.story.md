# Story 1.6: Plan View Implementation

## Status
Done

## Story
**As a** user,
**I want** to browse planning documents in the TUI,
**so that** I can review PRDs, architecture docs, and workflows.

## Acceptance Criteria
1. Left pane shows document tree: PRD, Architecture, Epics, Stories
2. Documents indexed from configured paths (docs/prd.md, docs/architecture.md, etc.)
3. Right pane displays Glamour-rendered markdown with syntax highlighting
4. [tab] switches focus between panes
5. Arrow keys navigate document list
6. [s]pec, [w]orkflow, [c]onfig modes available (can be minimal for MVP)
7. Markdown rendering updates when selecting different documents

## Tasks / Subtasks
- [x] Create Document Engine for document discovery and indexing (AC: 1, 2)
  - [x] Create `internal/docs/scanner.go` to scan docs/ directory for markdown files
  - [x] Create `internal/docs/indexer.go` to build DocumentIndex structure
  - [x] Implement DocumentIndex type with path, title, type (prd/architecture/epic/story), modified_at fields
  - [x] Group documents by type for hierarchical tree display
  - [x] Cache document index for performance
- [x] Implement Plan view with two-pane layout (AC: 1, 3)
  - [x] Create `internal/tui/views/plan/plan.go` with Bubbletea model
  - [x] Implement left pane for document tree using list component
  - [x] Implement right pane for content display area
  - [x] Add PlanState struct with documents []DocumentIndex, selected int, content string, focusedPane PaneType
  - [x] Apply Lipgloss styling for pane borders and layout
- [x] Integrate Glamour markdown rendering (AC: 3, 7)
  - [x] Create `internal/docs/renderer.go` for Glamour integration
  - [x] Configure Glamour with terminal-appropriate style theme
  - [x] Implement RenderMarkdown function to process markdown files
  - [x] Add syntax highlighting for code blocks
  - [x] Handle rendering errors gracefully with fallback to plain text
- [x] Implement pane focus management (AC: 4)
  - [x] Add focusedPane field to PlanState (list, content)
  - [x] Implement tab key handler to switch between panes
  - [x] Update visual styling to indicate focused pane
  - [x] Ensure keyboard input routes to focused pane only
- [x] Add document list navigation (AC: 5)
  - [x] Implement arrow key handlers (up/down) for list navigation
  - [x] Add selected document highlighting in list
  - [x] Implement Enter key to load selected document
  - [x] Add Home/End keys for jump to first/last document
  - [x] Scroll list when selection moves out of view
- [x] Implement document loading and display (AC: 7)
  - [x] Load markdown file when document selected
  - [x] Pass content through Glamour renderer
  - [x] Display rendered content in right pane
  - [x] Handle file read errors with user-friendly messages
  - [x] Add loading indicator for large documents
- [x] Add view mode switching (AC: 6)
  - [x] Implement 's' key handler for spec mode (can show placeholder)
  - [x] Implement 'w' key handler for workflow mode (can show placeholder)
  - [x] Implement 'c' key handler for config mode (can show placeholder)
  - [x] Update footer to show available mode keys
  - [x] Store current mode in PlanState
- [x] Integrate with file watcher for live updates
  - [x] Watch docs/ directory for markdown file changes
  - [x] Refresh document index when files added/removed
  - [x] Reload current document if it changes on disk
  - [x] Use fsnotify for cross-platform file watching
- [x] Handle terminal resize in Plan view
  - [x] Update pane widths on WindowSizeMsg
  - [x] Reflow markdown content for new width
  - [x] Maintain scroll position when resizing
  - [x] Ensure minimum pane widths for readability
- [x] Add document discovery configuration
  - [x] Read paths from core-config.yaml (prd, architecture locations)
  - [x] Support both monolithic and sharded document structures
  - [x] Handle missing documents gracefully
  - [x] Provide default paths if config not found
- [x] Add unit tests for Plan view components
  - [x] Test document scanner and indexer logic
  - [x] Test Glamour renderer integration
  - [x] Test pane focus switching
  - [x] Test document selection and loading
  - [x] Test keyboard navigation
- [x] Integration testing
  - [x] Test complete Plan view launch from TUI
  - [x] Test document discovery with various directory structures
  - [x] Test markdown rendering with different content types
  - [x] Test file watching and live updates

## Dev Notes

### Previous Story Insights
From Story 1.5 implementation:
- TUI foundation established with Bubbletea framework in `internal/tui/app/app.go`
- Component pattern implemented with Init(), Update(), View() methods
- View switching between Plan and Observe already working
- Header/footer components display current view and keybinds
- Lipgloss styling patterns established in `internal/tui/styles/theme.go`
- WindowSizeMsg handling for terminal resize already implemented
- Plan view placeholder exists at `internal/tui/views/plan/plan.go`

### DocumentIndex Data Model
**Structure Requirements** [Source: architecture/data-models.md#documentindex]:
```go
type DocumentType string

const (
    DocTypePRD          DocumentType = "prd"
    DocTypeArchitecture DocumentType = "architecture"
    DocTypeEpic         DocumentType = "epic"
    DocTypeStory        DocumentType = "story"
)

type DocumentIndex struct {
    Path       string       // Absolute file path
    Title      string       // Document title extracted from first # heading
    Type       DocumentType // Document category
    ModifiedAt time.Time    // Last modification time
}
```
Documents grouped by DocumentType for hierarchical navigation in tree view.

### Document Engine Architecture
**Component Responsibilities** [Source: architecture/components.md#document-engine]:
- File system scanning for markdown documents in docs/ directory
- Document indexing and caching for performance
- Integration with Glamour for markdown rendering

**File Locations** [Source: architecture/unified-project-structure.md]:
```
internal/docs/
├── scanner.go    # Scans docs/ directory for markdown files
├── indexer.go    # Builds and maintains document index
└── renderer.go   # Glamour markdown rendering integration
```

### Plan View State Management
**PlanState Structure** [Source: architecture/frontend-architecture.md#state-structure]:
```go
type PaneType string

const (
    PaneList    PaneType = "list"
    PaneContent PaneType = "content"
)

type PlanState struct {
    documents   []DocumentIndex // Indexed documents from docs/
    selected    int            // Currently selected document index
    content     string         // Rendered markdown content
    focusedPane PaneType       // Currently focused pane
    viewMode    string         // Current mode: "normal", "spec", "workflow", "config"
}
```

### Glamour Configuration
**Technology Requirements** [Source: architecture/tech-stack.md#technology-stack-table]:
- Glamour v0.6+ for markdown rendering with syntax highlighting
- Configure with terminal-appropriate style theme
- Support for code block syntax highlighting
- Graceful fallback to plain text on rendering errors

**Rendering Workflow** [Source: architecture/core-workflows.md#document-browser-workflow]:
1. Plan View requests document content
2. Document Engine reads markdown file from filesystem
3. Content passed to Glamour renderer
4. Styled terminal output returned
5. Plan view displays in content pane

### Navigation and Key Bindings
**Key Handler Pattern** [Source: architecture/frontend-architecture.md#route-organization]:
```go
func (m PlanView) handleKeys(msg tea.KeyMsg) (tea.Model, tea.Cmd) {
    switch msg.String() {
    case "tab":
        // Switch pane focus
    case "up", "down":
        // Navigate document list (only when list focused)
    case "enter":
        // Load selected document
    case "s", "w", "c":
        // Switch view modes
    }
}
```

### File Watching Integration
**File Watcher Service** [Source: architecture/frontend-architecture.md#file-watching-service]:
```go
type FileWatcherService struct {
    watcher *fsnotify.Watcher
    events  chan FileChangeMsg
}

// Returns Bubbletea command for UI updates
func (s *FileWatcherService) WatchDocuments() tea.Cmd
```
Use fsnotify v1.7+ for cross-platform file watching capability.

### Component Organization
**Bubbletea Component Pattern** [Source: architecture/frontend-architecture.md#component-template]:
```go
type PlanView struct {
    width      int
    height     int
    styles     lipgloss.Style
    state      *PlanState
    docEngine  *docs.Engine
}

func (v PlanView) Init() tea.Cmd {
    // Initialize document scanning
    return v.docEngine.ScanDocuments()
}

func (v PlanView) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    // Handle messages and update state
}

func (v PlanView) View() string {
    // Render the two-pane layout
}
```

### Pane Layout Implementation
**Two-Pane Layout**:
- Left pane: 30% width for document tree
- Right pane: 70% width for content display
- Minimum widths: left=20 chars, right=40 chars
- Use lipgloss.JoinHorizontal for pane composition
- Apply borders and padding per theme styles

### Document Discovery Configuration
**Config Reading** [Source: core-config.yaml]:
```yaml
prd:
  prdFile: docs/prd.md
  prdSharded: true
  prdShardedLocation: docs/prd
architecture:
  architectureFile: docs/architecture.md
  architectureSharded: true
  architectureShardedLocation: docs/architecture
devStoryLocation: docs/stories
```
Support both monolithic files and sharded directory structures.

### Error Handling
**TUI Error Display** [Source: architecture/error-handling-strategy.md#tui-error-handling]:
- Display user-friendly error messages in content pane
- Provide actionable guidance (e.g., "Document not found")
- Log detailed errors to `.spcstr/logs/` for debugging
- Never crash TUI on document errors

### Performance Requirements
- Document indexing should complete in <500ms for typical projects
- Markdown rendering should display in <200ms
- Pane switching should feel instant (<50ms)
- Smooth scrolling in document list

### Testing

### Test Requirements from Architecture
**Testing Framework** [Source: architecture/testing-strategy.md#test-organization]:
- Built-in Go testing with table-driven patterns
- Unit tests co-located with source using `_test.go` suffix
- Integration tests in `tests/integration/` directory

### Specific Testing for This Story
**Document Engine Tests** (`internal/docs/`):
- `scanner_test.go`: Test directory scanning and file discovery
- `indexer_test.go`: Test document indexing and categorization
- `renderer_test.go`: Test Glamour rendering with various markdown

**Plan View Tests** (`internal/tui/views/plan/`):
- `plan_test.go`: Test view initialization and state management
- Test pane focus switching logic
- Test document selection and loading
- Test keyboard navigation handlers

**Integration Tests** (`tests/integration/plan_view_test.go`):
- Test complete Plan view with real documents
- Test file watching and live reload
- Test error handling with missing documents
- Test performance requirements

**Manual Testing** (`tests/manual/plan_view_test_steps.md`):
- Launch TUI and navigate to Plan view with 'p'
- Verify document tree displays all categories
- Test tab switching between panes
- Test document selection and rendering
- Test view modes (s/w/c keys)
- Verify file watching by editing a document externally

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-06 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Height calculation issue: Plan view not accounting for header/footer properly (should be height - 3)
- Bubbletea pattern issue: Discovered Update() returns new model instances that must be saved
- Import path issue: main.go was importing wrong TUI package

### Completion Notes List
**Working Features:**
- Document engine successfully scans and indexes markdown files from docs/ directory
- Glamour markdown rendering is integrated and renders markdown with syntax highlighting
- Keyboard navigation implemented (arrow keys, tab switching, home/end keys)
- File watching for live document updates is functional
- Configuration support from core-config.yaml for document paths
- Document categorization by type (PRD, Architecture, Epic, Story)
- Pane focus switching with visual indicators
- View mode switching (s/w/c keys) with placeholder support
- Unit tests for document engine components pass
- Build compiles successfully with all dependencies

**Partially Working:**
- UI layout mostly works but isn't perfect - panes display with borders
- Height calculations improved using MaxHeight/Width constraints
- Content panes now flex-fill their allocated space
- Terminal boundaries are mostly respected

**Known UI Issues (To Revisit):**
- Borders could be more consistent/polished
- Some edge cases with very long documents may still have scrolling issues
- Terminal resize handling needs more testing
- Pane padding/margins could use refinement for better visual balance
- Content overflow handling needs improvement for very wide lines

**Fixed During Implementation:**
- Fixed Bubbletea model update pattern (models are immutable, must save returned model)
- Fixed Plan view initialization to properly call Init() for document loading
- Fixed import paths in main.go to use correct app package
- Fixed height overflow using MaxWidth/MaxHeight instead of Width/Height
- Added proper padding to ensure borders always show

**Note:** The Plan view is functional and usable but the UI polish needs a dedicated refinement pass. The core functionality is complete and working.

### File List
- internal/docs/scanner.go (created)
- internal/docs/indexer.go (created)
- internal/docs/renderer.go (created)
- internal/docs/types.go (created)
- internal/docs/watcher.go (created)
- internal/docs/scanner_test.go (created)
- internal/docs/indexer_test.go (created)
- internal/docs/renderer_test.go (created)
- internal/config/config.go (created)
- internal/tui/views/plan/plan.go (modified)
- internal/tui/views/plan/plan_test.go (created)
- tests/integration/plan_view_test.go (created)
- go.mod (modified - dependencies added)
- go.sum (modified - dependencies added)

## QA Results

FAIL --> docs/stories/1.6.story-change-1.md
