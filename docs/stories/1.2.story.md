# Story 1.2: Init Command Implementation

## Status
Approved

## Story
**As a** user,
**I want** to initialize spcstr in my project with a single command,
**so that** all necessary hooks and configuration are automatically set up.

## Acceptance Criteria
1. `spcstr init` creates .spcstr/ directory structure
2. Hook scripts are written to .spcstr/hooks/ directory
3. Claude settings.json is updated with hook configurations
4. Command detects existing configuration and prompts before overwriting
5. Success message confirms initialization with next steps

## Tasks / Subtasks
- [ ] Enhance internal/cli/init.go command implementation (AC: 1, 2, 3, 4, 5)
  - [ ] Add command description and long help text
  - [ ] Implement RunE function with proper error handling
  - [ ] Parse command line flags (--force for overwrite)
- [ ] Create internal/config package structures (AC: 1, 4)
  - [ ] Create internal/config/config.go with Configuration struct
  - [ ] Create internal/config/loader.go with LoadConfig/SaveConfig functions
  - [ ] Create internal/config/validator.go with ValidateConfig function
  - [ ] Create internal/config/xdg.go with XDG base directory support
  - [ ] Define JSON schema for config.json based on architecture specs
- [ ] Create internal/hooks package for hook management (AC: 2, 3)
  - [ ] Create internal/hooks/generator.go with GenerateHooks function
  - [ ] Create internal/hooks/installer.go with InstallHooks function
  - [ ] Create internal/hooks/templates.go with embedded shell script templates
  - [ ] Create internal/hooks/claude.go with UpdateClaudeSettings function
  - [ ] Create scripts/hooks/template.sh.tmpl with hook script template
  - [ ] Create scripts/hooks/common.sh with shared hook functions
- [ ] Implement .spcstr directory creation logic (AC: 1)
  - [ ] Check if .spcstr directory already exists
  - [ ] Create directory structure: config.json, sessions/, hooks/, cache/, logs/
  - [ ] Set appropriate file permissions (0755 for dirs, 0644 for files, 0755 for scripts)
  - [ ] Handle existing directory scenarios with prompting
- [ ] Implement hook script generation (AC: 2)
  - [ ] Generate pre-command.sh hook script
  - [ ] Generate post-command.sh hook script
  - [ ] Generate file-modified.sh hook script
  - [ ] Generate session-end.sh hook script
  - [ ] Ensure scripts are POSIX-compliant with proper error handling
  - [ ] Scripts must never block Claude Code (exit 0 always)
- [ ] Implement Claude settings.json update (AC: 3)
  - [ ] Locate Claude settings.json file (check multiple possible locations)
  - [ ] Parse existing settings safely
  - [ ] Add/update hook configurations without breaking existing settings
  - [ ] Create backup of original settings before modification
  - [ ] Handle missing settings.json gracefully
- [ ] Implement overwrite detection and prompting (AC: 4)
  - [ ] Check for existing .spcstr directory
  - [ ] Check for existing hook entries in Claude settings.json
  - [ ] Prompt user for confirmation if conflicts found (unless --force flag)
  - [ ] Provide clear information about what will be overwritten
- [ ] Add success message and next steps (AC: 5)
  - [ ] Display clear success message with what was created
  - [ ] Show location of created files
  - [ ] Provide next steps for user (e.g., "Run 'spcstr run' to start TUI")
  - [ ] Include troubleshooting hints if applicable
- [ ] Write comprehensive unit tests
  - [ ] Test init command with various flags in internal/cli/init_test.go
  - [ ] Test config package functions in internal/config/*_test.go files
  - [ ] Test hooks package functions in internal/hooks/*_test.go files
  - [ ] Test directory creation with existing/non-existing scenarios
  - [ ] Test Claude settings update with various edge cases
  - [ ] Use table-driven tests following established patterns
  - [ ] Achieve minimum 80% coverage for new packages

## Dev Notes

### Previous Story Insights
From Story 1.1 implementation:
- CLI structure established with Cobra 1.8.0
- Placeholder init command already exists at internal/cli/init.go
- Testing patterns established with table-driven tests achieving 97.4% coverage
- All commands use cmd.OutOrStdout() for testable output (never fmt.Print)
- Error handling follows wrapped errors with context using %w

### Project Structure
Based on [Source: architecture/source-tree.md], the following files need to be created/updated:

**Existing file to update:**
- internal/cli/init.go - Enhance from placeholder to full implementation

**New directories and files to create:**
```
internal/
├── config/
│   ├── config.go               # Configuration structures
│   ├── loader.go               # Config loading logic
│   ├── validator.go            # Config validation
│   └── xdg.go                  # XDG directory handling
├── hooks/
│   ├── generator.go            # Hook script generation
│   ├── installer.go            # Hook installation logic
│   ├── templates.go            # Shell script templates
│   └── claude.go               # Claude settings updater
scripts/
├── hooks/
│   ├── template.sh.tmpl        # Hook script template
│   └── common.sh               # Shared hook functions
```

**Runtime directory structure to be created by init command:**
```
.spcstr/
├── config.json                 # Project configuration
├── sessions/                   # Session data directory
│   ├── active/                 # Active sessions
│   └── archive/                # Completed sessions
├── hooks/                      # Generated hook scripts
│   ├── pre-command.sh
│   ├── post-command.sh
│   ├── file-modified.sh
│   └── session-end.sh
├── cache/                      # Application cache
│   └── document-index.json
└── logs/                       # Debug logs
    └── debug.log
```

### Configuration Schema
From [Source: architecture/database-schema.md#configuration-schema]:
```json
{
  "version": "1.0.0",
  "scope": "project",
  "paths": {
    "hooks": ".spcstr/hooks",
    "sessions": ".spcstr/sessions",
    "docs": ["docs/"]
  },
  "ui": {
    "theme": "dark",
    "refreshInterval": 500
  },
  "session": {
    "retentionDays": 30,
    "autoArchive": true,
    "maxActiveSession": 10
  }
}
```

### Hook Manager Component Details
From [Source: architecture/components.md#hook-manager-component]:
- **GenerateHooks()**: Create POSIX-compliant shell scripts
- **InstallHooks()**: Write hooks to .spcstr/hooks/
- **UpdateClaudeSettings()**: Modify Claude's settings.json
- Technology: Go templates for script generation, encoding/json for settings

### Config Manager Component Details
From [Source: architecture/components.md#config-manager-component]:
- **LoadConfig()**: Read configuration from disk
- **SaveConfig()**: Persist configuration changes
- **MergeConfigs()**: Combine global and project settings
- **ValidateConfig()**: Ensure configuration integrity
- XDG base directory spec compliance required

### Hook Script Requirements
From [Source: architecture/error-handling-strategy.md#hook-script-error-handling]:
- **CRITICAL**: Hook scripts must NEVER block Claude Code
- Must use `set +e` to not exit on error
- Must always exit with code 0
- Log errors to .spcstr/logs/hook-errors.log

Example hook script pattern:
```bash
#!/bin/sh
set +e  # Don't exit on error
operation || echo "Error: $?" >> .spcstr/logs/hook-errors.log
exit 0  # Always exit successfully
```

### Security Considerations
From [Source: architecture/security.md#shell-script-security]:
- Use printf instead of echo for variables
- Always quote variables: "${VAR}"
- Validate all paths before operations
- No eval or source of user input
- Set restrictive umask (0077) for sensitive files

### File Permissions
From [Source: architecture/security.md#file-system-security]:
- Directories: 0755 (rwxr-xr-x)
- Configuration files: 0644 (rw-r--r--)
- Hook scripts: 0755 (rwxr-xr-x) - must be executable
- Log files: 0644 (rw-r--r--)

### Error Handling Requirements
From [Source: architecture/error-handling-strategy.md]:
- All errors must be wrapped with context using fmt.Errorf("%w")
- File system errors are recoverable - retry with exponential backoff
- Configuration errors require user intervention
- Use slog for all logging (no fmt.Print)

### Technical Constraints
- Go version: 1.21.0 [Source: architecture/tech-stack.md]
- Must use encoding/json for JSON operations
- Must use Go templates for script generation
- XDG base directory specification compliance required
- POSIX shell compatibility required (no bash-specific features)

## Testing
### Testing Standards
From [Source: architecture/test-strategy-and-standards.md]:
- Test file location: Same directory as source with _test.go suffix
- Test framework: Go standard library testing package
- Mock framework: testify/mock 1.8.4
- Coverage target: 80% minimum for new packages
- Test pattern: Table-driven tests required
- All public functions must have tests
- Error paths must be explicitly tested
- Use testify/assert for assertions

### Test Organization
- internal/cli/init_test.go - Test init command and flags
- internal/config/config_test.go - Test configuration structures
- internal/config/loader_test.go - Test loading/saving functions
- internal/config/validator_test.go - Test validation logic
- internal/config/xdg_test.go - Test XDG directory handling
- internal/hooks/generator_test.go - Test hook generation
- internal/hooks/installer_test.go - Test installation logic
- internal/hooks/templates_test.go - Test template rendering
- internal/hooks/claude_test.go - Test Claude settings updates

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-05 | 1.0 | Initial story draft created | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
