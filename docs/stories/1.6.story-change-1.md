# Sprint Change Proposal: Story 1.6 TUI Layout Refinement

## Change Navigation Analysis

### 1. Identified Issue Summary

**Triggering Story:** Story 1.6 - Plan View Implementation

**Core Problem:** The Plan view's layout uses overly complex manual calculations for pane sizing that fight against lipgloss's natural layout system. James is experiencing difficulties because the implementation is overthinking simple layout patterns.

**Evidence from Implementation:**
- Complex percentage calculations: `(m.width * 30) / 100` with multiple conditionals
- Manual minimum width checking and adjustment logic
- Trying to account for every pixel of border/padding manually
- Fighting lipgloss instead of letting it handle layout naturally

**What Actually Works:**
- `MaxWidth()`/`MaxHeight()` were CORRECTLY added to fix overflow issues - keep them!
- The core structure is solid, just needs simplification

### 2. Epic Impact Assessment

**Current Epic Status:** Epic 1 (TUI Foundation) is at risk
- Story 1.5 (TUI Foundation) ‚úÖ Complete
- Story 1.6 (Plan View) ‚ö†Ô∏è Partially working, needs refinement
- Story 1.7 (Observe View) üîÆ Blocked by layout pattern issues

**Impact Analysis:**
- Current epic can be completed with targeted fixes to Story 1.6
- Future stories in Epic 1 will benefit from establishing correct layout patterns
- No need to abandon or fundamentally redefine the epic
- Story 1.7 implementation will be smoother with proper patterns established

### 3. Artifact Conflict & Impact Analysis

**Architecture Document Review:**
- Frontend architecture patterns remain valid
- Component structure (Init/Update/View) is correctly implemented
- No conflicts with documented Bubbletea patterns

**Story 1.6 Notes:**
Story already acknowledges UI issues in completion notes:
- "Borders could be more consistent/polished"
- "Terminal resize handling needs more testing"
- "Pane padding/margins could use refinement"

**No artifact updates required** - issues are implementation-specific, not architectural

### 4. Path Forward Evaluation

**Selected Path: Direct Adjustment/Integration**

Modify the Plan view implementation to follow proper lipgloss patterns discovered in framework examples. This is a targeted fix that doesn't require rollback or re-scoping.

**Rationale:**
- Core functionality works (document loading, navigation, rendering)
- Only the layout/sizing needs refinement
- Examples from lipgloss/bubbletea repos provide clear patterns to follow
- Risk is minimal - changes are isolated to view layer

### 5. Specific Proposed Edits

## Technical Changes Required

**KEY INSIGHT:** The MaxWidth/MaxHeight calls were the FIX for overflow issues - keep them! The real problem is overthinking the layout with complex percentage calculations. Lipgloss works better with simpler constraints.

### A. Simplify Layout Calculations

**Issue:** Current implementation uses complex manual percentage calculations:
```go
// Current overcomplicated pattern (lines 291-299)
leftPaneWidth := (m.width * 30) / 100
if leftPaneWidth < 20 {
    leftPaneWidth = 20
}
rightPaneWidth := m.width - leftPaneWidth - 2
if rightPaneWidth < 40 {
    rightPaneWidth = 40
}
```

**Fix:** Follow simpler patterns from lipgloss examples:
```go
// Option 1: Fixed column width (from layout/main.go)
const leftPaneWidth = 35  // Fixed width for document list
rightPaneWidth := m.width - leftPaneWidth - 1

// Option 2: Simple division (from split-editors/main.go)
leftPaneWidth := m.width / 3
rightPaneWidth := m.width - leftPaneWidth - 1
```

**Note:** KEEP the MaxWidth/MaxHeight calls - they fixed overflow issues!

### B. Use lipgloss.Place for Better Content Control

**Issue:** Manual content overflow handling and scrolling calculations

**Fix:** Use lipgloss.Place for automatic content positioning:
```go
// From layout/main.go example (line 248-253)
dialog := lipgloss.Place(
    width, 
    height,
    lipgloss.Left,    // horizontal alignment
    lipgloss.Top,     // vertical alignment  
    renderedContent,
)
```

This handles overflow automatically without manual calculations.

### C. Simplified Render Methods

**Keep the current MaxWidth/MaxHeight pattern but simplify dimensions:**
```go
func (m Model) renderListPane(width, height int) string {
    // ... existing list building logic ...
    
    paneStyle := m.paneStyles.ListPane
    if m.state.focusedPane == PaneList {
        paneStyle = paneStyle.
            BorderStyle(m.paneStyles.FocusedBorder.GetBorderStyle()).
            BorderForeground(m.paneStyles.FocusedBorder.GetBorderTopForeground())
    }
    
    // KEEP MaxWidth/MaxHeight - they prevent overflow!
    return paneStyle.
        Width(width).
        Height(height).
        MaxWidth(width).    // Keep this!
        MaxHeight(height).  // Keep this!
        Render(content)
}
```

### D. Simplified WindowSizeMsg Handling

**Simplify dimension calculations:**
```go
case tea.WindowSizeMsg:
    m.width = msg.Width
    m.height = msg.Height - 3  // Account for header/footer
    
    // Update renderer width (simpler calculation)
    if m.docEngine != nil && m.width > 40 {
        // Just use 2/3 of width for content, no complex math
        contentWidth := (m.width * 2) / 3
        m.docEngine.Renderer.SetWidth(contentWidth)
    }
```

## Implementation Checklist

1. [ ] Simplify pane width calculations (remove percentage math)
2. [ ] KEEP MaxWidth/MaxHeight calls (they fixed overflow!)
3. [ ] Consider using lipgloss.Place for content positioning
4. [ ] Use fixed column width or simple division
5. [ ] Remove minimum width checks and complex calculations
6. [ ] Test with various terminal sizes
7. [ ] Verify borders render consistently
8. [ ] Consider if scrolling logic can be simplified
9. [ ] Test that overflow is still prevented

## Example Code References

### From lipgloss examples/layout/main.go:
- Line 103-111: Proper border style definition
- Line 131: Width setting for list component
- Line 201: JoinHorizontal usage

### From bubbletea examples/split-editors/main.go:
- Line 172-173: SetWidth/SetHeight pattern
- Line 153-154: WindowSizeMsg handling
- Line 196: JoinHorizontal for multiple panes

### From bubbletea examples/composable-views/main.go:
- Line 46-56: Style definition with Width/Height
- Line 127-129: Conditional style rendering based on focus

## Success Criteria

1. Panes fill allocated space without overflow
2. Borders render consistently on all sides
3. Terminal resize maintains layout proportions
4. Focus switching shows clear visual feedback
5. Content scrolling works within pane boundaries
6. No visual artifacts or rendering glitches

## Risk Assessment

**Very Low Risk:** This is a SIMPLIFICATION, not a refactor
- We're removing code, not adding complexity
- MaxWidth/MaxHeight stay (they're the fix!)
- Just replacing complex math with simple division
- No data model or business logic changes
- Tests should still pass (and might even be more stable)

## Next Steps

1. **Immediate:** Implement the proposed changes to `internal/tui/views/plan/plan.go`
2. **Testing:** Manual testing with various terminal sizes and document types
3. **Validation:** Ensure all Story 1.6 acceptance criteria still pass
4. **Documentation:** Update story notes with resolution of UI issues
5. **Handoff:** Once validated, proceed with Story 1.7 using established patterns

## Agent Handoff Plan

**For James (Dev Agent):**
- Use this proposal as implementation guide
- Reference the specific line numbers and examples provided
- Test thoroughly with different terminal sizes
- Apply same patterns to Story 1.7 (Observe View)

**For Bob (Scrum Master):**
- No epic restructuring needed
- Story 1.6 remains in current epic
- Update story status to "In Refinement"
- No PRD or architecture updates required

## Approval

This proposal recommends targeted implementation fixes following established lipgloss/bubbletea patterns. The changes are low-risk and will unblock further TUI development.

---
*Generated by: Bob (Scrum Master)*  
*Date: 2025-09-06*  
*Change Type: Technical Refinement*  
*Impact Level: Story-Level*